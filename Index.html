<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>editor-plugin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css">
</head>
<body>
    <style>
        .h-80{
            min-height:80px;
            height:auto;
        }
    </style>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <h4>Lấy hình ảnh từ MS WORD khi copy hình và chữ tới trình soạn thảo</h4>
                <p>Thư hiện hỗ trợ rtf.js: <a href="https://github.com/tbluemel/rtf.js">https://github.com/tbluemel/rtf.js</a></p>
                <p>Trong quá trình copy "chữ + hình ảnh" từ word, tệp hình ảnh đã được mã hóa sang base 64 với type là text/rtf  nhưng khi paste vào editor chỉ nhận là dạng plain/text hoặc text/html</p>
                <p>Thư viện rtf.js để đọc nội dung text/rtf (Rich Text Format) khi copy và chuyển đổi lại sang html, nội dung này được lấy từ ClipboardData</p>
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col-md-6 border-right border-back">
                <h5>1.Div editor contenteditable</h5>
                <div id="txtEditor" class="w-100 h-80 border" contenteditable="true"></div>
                <h5>2.Kendo Editor</h5>
                <p>tương tự</p>
                <h5>3.Tinymce Editor</h5>
                <p>tương tự</p>
            </div>
            <div class="col-md-6">
                <p>Nội dung từ word</p>
                <img src="../Capture1.png" alt="Hình ảnh demo" width="100" height="50"/>
                <pre>
                    <code class="languahe-js">
        const KENDO_EDITOR = "KENDO_EDITOR";
        const TINYMCE_EDITOR = "TINYMCE_EIDTOR";
        const CK_EDITOR = "CK_EIDTOR";
        // Copy hình và chữ từ word và paste tới editor
        document.getElementById("txtEditor").onpaste = function (event) {
            // nếu lấy cấu hình giữ format từ word của plugin nên xóa default
            event.preventDefault();
            retrieveImageFromClipboardAsBase64('#txtEditor', event)
        };
        function retrieveImageFromClipboardAsBase64(elm, pasteEvent, pluginEditor, callback) {
            pluginEditor = pluginEditor || "";
            if (pasteEvent.clipboardData == false) {
                if (typeof (callback) == "function") {
                    callback(undefined);
                }
            };
            var items = pasteEvent.clipboardData.items;
            if (items == undefined) {
                if (typeof (callback) == "function") {
                    callback(undefined);
                }
            };
            for (var i = 0; i < items.length; i++) {
                // text/rtf là nội dung copy từ word
                if (items[i].type.indexOf('text/rtf') === 0) {
                    var rtf = pasteEvent.clipboardData.getData('text/rtf');
                    var stringToBinaryArray = function (txt) {
                        var buffer = new ArrayBuffer(txt.length);
                        var bufferView = new Uint8Array(buffer);
                        for (var i = 0; i < txt.length; i++) {
                            bufferView[i] = txt.charCodeAt(i);
                        }
                        return buffer;
                    }
                    // phương thức RTFJS.Document đọc nội dung tới html từ thư viện rtf.js
                    var doc = new RTFJS.Document(stringToBinaryArray(rtf), {});
                    doc.render()
                        .then(function (htmlElements) {
                            const div = document.createElement("div");
                            div.append(...htmlElements);

                            // xóa thẻ svg còn lại của word
                            <span class="hljs-regexp">var pattFont = /<svg (.*?)<\/svg>/;</span>
                            var regexFont = new RegExp(pattFont, "g");
                            div.innerHTML = div.innerHTML.replace(regexFont, function (m) {
                                return "";
                            });

                            // xóa nội dung Unsupported image format bên dưới hình ảnh
                            div.innerHTML = div.innerHTML.replace(/\[Unsupported image format\]/g, '');

                            //convertImageFromFileWordWithBase64(div.innerHTML);

                            // =============================== Hiển thị lại văn bản ===============================//
                            // 1. Cách 1 hiển thị lại văn bản word từ nội dung rtf, có nhiều chổ không giữ được format
                            switch (pluginEditor) {
                                case KENDO_EDITOR:
                                    break;
                                case TINYMCE_EDITOR:
                                    break;
                                case CK_EDITOR:
                                    break;
                                default:
                                    $(elm).html(div.innerHTML);
                            }

                            // 2.Cách 2 Cấu hình lấy format từ word của trình editor tích hợp,
                            // chỉ lấy thẻ image base 64 trả về (có thể cấu hình đường dẫn để lưu lại file của mình) không lấy nội dung từ rtf,
                            // sau đó append lại với các image local file:/C
                        })
                        .catch(function (error) {
                            console.log(error);
                            alert("Có hình ảnh không thể chuyển đổi, vui lòng chọn insert hình");
                        })
                }
            }
        }
                    </code>   
                </pre>
            </div>
        </div>
        
    </div>
    

    <!--Jquery and library-->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
    <script src="https://tbluemel.github.io/rtf.js/dist/RTFJS.bundle.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        });

        const KENDO_EDITOR = "KENDO_EDITOR";
        const TINYMCE_EDITOR = "TINYMCE_EIDTOR";
        const CK_EDITOR = "CK_EIDTOR";

        // Copy hình và chữ từ word và paste tới editor
        document.getElementById("txtEditor").onpaste = function (event) {

            // nếu lấy cấu hình giữ format từ word của plugin nên xóa default
            event.preventDefault();

            retrieveImageFromClipboardAsBase64('#txtEditor', event)
        };

        function retrieveImageFromClipboardAsBase64(elm, pasteEvent, pluginEditor, callback) {
            pluginEditor = pluginEditor || "";
            if (pasteEvent.clipboardData == false) {
                if (typeof (callback) == "function") {
                    callback(undefined);
                }
            };

            var items = pasteEvent.clipboardData.items;

            if (items == undefined) {
                if (typeof (callback) == "function") {
                    callback(undefined);
                }
            };

            for (var i = 0; i < items.length; i++) {

                // text/rtf là nội dung copy từ word
                if (items[i].type.indexOf('text/rtf') === 0) {
                    var rtf = pasteEvent.clipboardData.getData('text/rtf');
                    var stringToBinaryArray = function (txt) {
                        var buffer = new ArrayBuffer(txt.length);
                        var bufferView = new Uint8Array(buffer);
                        for (var i = 0; i < txt.length; i++) {
                            bufferView[i] = txt.charCodeAt(i);
                        }
                        return buffer;
                    }

                    // phương thức RTFJS.Document đọc nội dung tới html từ thư viện rtf.js
                    var doc = new RTFJS.Document(stringToBinaryArray(rtf), {});
                    doc.render()
                        .then(function (htmlElements) {
                            const div = document.createElement("div");
                            div.append(...htmlElements);

                            // xóa thẻ svg còn lại của word
                            //var pattFont = /<svg (.*?)<\/svg>/;
                            //var regexFont = new RegExp(pattFont, "g");
                            //div.innerHTML = div.innerHTML.replace(regexFont, function (m) {
                            //    return "";
                            //});

                            div.innerHTML = div.innerHTML.replace(/<svg (.*?)<\/svg>/g, '');

                            // xóa nội dung Unsupported image format bên dưới hình ảnh
                            div.innerHTML = div.innerHTML.replace(/\[Unsupported image format\]/g, '');

                            //convertImageFromFileWordWithBase64(div.innerHTML);

                            // =============================== Hiển thị lại văn bản ===============================//
                            // 1. Cách 1 hiển thị lại văn bản word từ nội dung rtf, có nhiều chổ không giữ được format
                            switch (pluginEditor) {
                                case KENDO_EDITOR:                                    
                                    break;
                                case TINYMCE_EDITOR:
                                    break;
                                case CK_EDITOR:
                                    break;
                                default:
                                    $(elm).html(div.innerHTML);
                            }

                            // 2.Cách 2 Cấu hình lấy format từ word của trình editor tích hợp,
                            // chỉ lấy thẻ image base 64 trả về (có thể cấu hình đường dẫn để lưu lại file của mình) không lấy nội dung từ rtf,
                            // sau đó append lại với các image local file:///C
                        })
                        .catch(function (error) {
                            console.log(error);
                            alert("Có hình ảnh không thể chuyển đổi, vui lòng chọn insert hình");                           
                        })
                }               
            }
        }
    </script>
</body>
</html>
